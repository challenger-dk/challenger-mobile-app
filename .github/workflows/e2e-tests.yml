name: E2E Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  e2e-android:
    name: Maestro Cloud E2E Tests (Android)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # Required GitHub Secrets (Settings > Secrets and variables > Actions):
    # - MAESTRO_CLOUD_API_KEY: Your Maestro Cloud API key (required)
    # - MAESTRO_PROJECT_ID: Your Maestro Cloud project ID (optional, will prompt if not set)
    #
    # Optional environment variables for app build:
    # - EXPO_PUBLIC_API_BASE_URL (defaults to http://10.0.2.2:8000)
    # - EXPO_PUBLIC_TOMTOM_API_KEY (optional, defaults to test-key)
    # - EXPO_PUBLIC_CHAT_API_URL (defaults to http://10.0.2.2:8002)
    # - EXPO_PUBLIC_WS_URL (defaults to ws://10.0.2.2:8002)
    # - EXPO_PUBLIC_GOOGLE_MAPS_API_KEY (optional, defaults to test-key)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: npm ci

      - name: Install Maestro CLI
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          export PATH="$PATH:$HOME/.maestro/bin"
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH
          maestro --version

      - name: Build Android APK
        env:
          EXPO_PUBLIC_API_BASE_URL: ${{ secrets.EXPO_PUBLIC_API_BASE_URL }}
          EXPO_PUBLIC_TOMTOM_API_KEY: ${{ secrets.EXPO_PUBLIC_TOMTOM_API_KEY }}
          EXPO_PUBLIC_CHAT_API_URL: ${{ secrets.EXPO_PUBLIC_CHAT_API_URL }}
          EXPO_PUBLIC_WS_URL: ${{ secrets.EXPO_PUBLIC_WS_URL }}
          EXPO_PUBLIC_GOOGLE_MAPS_API_KEY: ${{ secrets.EXPO_PUBLIC_GOOGLE_MAPS_API_KEY }}
        run: |
          # Build debug APK for testing
          npm run android -- --no-build-cache
          
          # Find the generated APK
          APK_PATH=$(find android/app/build/outputs/apk -name "*.apk" | head -1)
          if [ -z "$APK_PATH" ]; then
            echo "Error: APK not found"
            exit 1
          fi
          echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV
          echo "Built APK: $APK_PATH"

      - name: Run Maestro Cloud Tests
        env:
          MAESTRO_CLOUD_API_KEY: ${{ secrets.MAESTRO_CLOUD_API_KEY }}
          MAESTRO_PROJECT_ID: ${{ secrets.MAESTRO_PROJECT_ID }}
        run: |
          # Run tests using Maestro Cloud
          # Upload the APK and test suite to Maestro Cloud
          # Note: We upload the full tests directory since the suite uses runFlow
          # to reference other test files (see https://docs.maestro.dev/cloud/cloud-quickstart)
          if [ -z "$MAESTRO_CLOUD_API_KEY" ]; then
            echo "Error: MAESTRO_CLOUD_API_KEY secret is required"
            echo "Get your API key from https://cloud.mobile.dev"
            exit 1
          fi
          
          # Build maestro cloud command
          # Upload the suite file - Maestro Cloud will handle finding referenced flows
          CMD="maestro cloud $APK_PATH .maestro/tests/suites/full.yaml"
          
          if [ -n "$MAESTRO_PROJECT_ID" ]; then
            CMD="$CMD --project-id $MAESTRO_PROJECT_ID"
          fi
          
          CMD="$CMD --api-key $MAESTRO_CLOUD_API_KEY"
          
          echo "Running Maestro Cloud tests..."
          echo "Command: $CMD"
          $CMD || {
            echo "Maestro Cloud tests failed"
            exit 1
          }

      - name: Upload APK artifact
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: ${{ env.APK_PATH }}
          retention-days: 7

