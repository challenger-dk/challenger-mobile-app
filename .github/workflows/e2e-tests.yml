name: Android & iOS E2E (Github Actions MacOS)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  MAESTRO_VERSION: 1.30.4

jobs:
  run_android_e2e:
    timeout-minutes: 30
    runs-on: macos-12

    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        arch: [x86_64]
        # Note: macOS runners don't support arm64-v8a for Android emulators
        api-level: [30, 31, 32, 33, 34]
        # API levels 21-29 are minimum supported but may have compatibility issues

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 11

      - name: Install dependencies
        run: npm ci

      - name: Install Maestro
        run: curl -Ls 'https://get.maestro.mobile.dev' | bash

      - name: Build Android APK
        env:
          EXPO_PUBLIC_API_BASE_URL: ${{ secrets.EXPO_PUBLIC_API_BASE_URL }}
          EXPO_PUBLIC_TOMTOM_API_KEY: ${{ secrets.EXPO_PUBLIC_TOMTOM_API_KEY }}
          EXPO_PUBLIC_CHAT_API_URL: ${{ secrets.EXPO_PUBLIC_CHAT_API_URL }}
          EXPO_PUBLIC_WS_URL: ${{ secrets.EXPO_PUBLIC_WS_URL }}
          EXPO_PUBLIC_GOOGLE_MAPS_API_KEY: ${{ secrets.EXPO_PUBLIC_GOOGLE_MAPS_API_KEY }}
        run: |
          npx expo prebuild --platform android --clean
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug --no-daemon
          cd ..
          # Copy APK to root for easier access
          cp android/app/build/outputs/apk/debug/*.apk app-release.apk

      - name: Run Maestro E2E tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api-level }}
          arch: ${{ matrix.arch }}
          cores: 2
          ram-size: 2048M
          force-avd-creation: false
          emulator-boot-timeout: 600
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: |
            npx envinfo
            adb devices
            adb install app-release.apk
            export EXPO_PUBLIC_DISABLE_LOGBOX=true
            export MAESTRO_APP_ID=com.daniellorenzen.challenger
            npm run test:e2e:full

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: E2E Report (Android ${{ matrix.api-level }})
          path: |
            *.mp4
            *.png
            report*.xml
            ~/.maestro/tests/**/*

  run_ios_e2e:
    runs-on: macos-12
    env:
      XC_SIMULATOR_NAME: iPhone 14

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Run iOS Simulator
        run: |
          echo "All valid available device types"
          xcrun simctl list devicetypes
          echo "All valid and available runtimes"
          xcrun simctl list runtimes
          echo "Run simulator"
          xcrun simctl boot "${{ env.XC_SIMULATOR_NAME }}"

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 11

      - name: Install Maestro
        run: |
          brew tap facebook/fb
          brew install facebook/fb/idb-companion
          curl -Ls 'https://get.maestro.mobile.dev' | bash

      - name: Build iOS app
        env:
          EXPO_PUBLIC_API_BASE_URL: ${{ secrets.EXPO_PUBLIC_API_BASE_URL }}
          EXPO_PUBLIC_TOMTOM_API_KEY: ${{ secrets.EXPO_PUBLIC_TOMTOM_API_KEY }}
          EXPO_PUBLIC_CHAT_API_URL: ${{ secrets.EXPO_PUBLIC_CHAT_API_URL }}
          EXPO_PUBLIC_WS_URL: ${{ secrets.EXPO_PUBLIC_WS_URL }}
          EXPO_PUBLIC_GOOGLE_MAPS_API_KEY: ${{ secrets.EXPO_PUBLIC_GOOGLE_MAPS_API_KEY }}
        run: |
          npx expo prebuild --platform ios --clean
          cd ios
          xcodebuild -workspace challengermobile.xcworkspace \
            -scheme challengermobile \
            -configuration Debug \
            -sdk iphonesimulator \
            -derivedDataPath build \
            -destination 'platform=iOS Simulator,name=iPhone 14' \
            build
          cd ..

      - name: Install .app
        run: |
          APP_PATH=$(find ios/build/Build/Products/Debug-iphonesimulator -name "*.app" | head -1)
          if [ -z "$APP_PATH" ]; then
            echo "Error: .app not found"
            find ios/build -name "*.app" || true
            exit 1
          fi
          xcrun simctl install booted "$APP_PATH"

      - name: Run Maestro E2E tests
        run: |
          export EXPO_PUBLIC_DISABLE_LOGBOX=true
          export MAESTRO_APP_ID=com.daniellorenzen.challenger
          npm run test:e2e:full

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: E2E Report (iPhone 14)
          path: |
            *.mp4
            *.png
            report*.xml
            ~/.maestro/tests/**/*
